{% extends "rabble/base.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <a href="{% url 'subrabble-detail' subrabble.rabble_name %}" class="text-decoration-none text-muted">
            ‚Üê Back to !{{ subrabble.rabble_name }} ‚Äî {{ subrabble.title }}
        </a>
    </div>

    <div class="mb-4">
        <h2>{{ post.title }}</h2>
        <p class="text-muted">By {{ post.user_id }}</p>
        <p>{{ post.body }}</p>

        <div class="d-flex justify-content-start align-items-center gap-3 mt-4">
            <span>

                <button id='like-button' data-user="{{ request.user.username }}" 
                data-url="{% url 'post-likes' subrabble.rabble_name post.id %}" 
                data-rabble="{{ subrabble.rabble_name }}"
                data-post="{{ post.id }}"
                data-liked="{{ liked|yesno:'true,false' }}" >
                    üëç {{ likes }}
                </button>
            </span>
            <span>üí¨ {{ comment_count }}</span>
            {% if user == post.user_id %}
                <a href="{% url 'post-edit' subrabble.rabble_name post.id %}" class="btn btn-outline-secondary btn-sm ms-2">
                    Edit Post
                </a>
            {% endif %}
        </div>
    </div>

    <hr>

    <h4>Comments</h4>

    {% if comment_count > 0 %}
        <ul class="list-group mb-3">
            {% for comment in comments %}
                <li class="list-group-item">
                    <p>{{ comment.body }}</p>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">By {{ comment.user_id }}</small>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No comments yet. Be the first to comment!</p>
    {% endif %}

{% csrf_token %}
<script>
    console.log("Script loaded");
    const likeButton = document.getElementById('like-button');
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    if (likeButton.dataset.liked === "true") {
        console.log(likeButton.dataset.liked);
        likeButton.style.backgroundColor = "gray";
    } else {
        console.log(likeButton.dataset.liked);
        likeButton.style.backgroundColor = "white";
    }

    async function updateLikes(url){
        try{
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
                },
                body: JSON.stringify({ rabble_name: likeButton.dataset.rabble, pk: likeButton.dataset.post })
            });

            const json = await response.json();
            console.log(json);

            likes = json.like_count;
            likeButton.textContent = `üëç ${likes}`;
            if (json.liked === true){
                likeButton.style.backgroundColor = "gray";
            } else{
                likeButton.style.backgroundColor = "white";
            }
        } catch(error){
            console.error(error.message);
        }
    }

    likeButton.addEventListener("click", function(){
        updateLikes(likeButton.dataset.url)
    });
</script>
{% endblock %}